---
layout: post
title: "How To Set Up a Malware Testing Environment"
---

So, you want to start analyzing Malware, huh? Playing around with something as dangerous as malware is both exciting and terrifying. This guide is here to help you protect your computer and home network when working with different variants of malware. Keep in mind that even though you will be using a sandbox environment to research and test malware you are not completely safe and there are some advanced malwares that can escape from a virtual environment. Always keep your virtualization software up to date and patched in order to mitigate against this risk. 

The first step in protecting yourself is to harden your real computer (host) and host Operating System (OS). Having antivirus software installed and running is a very good start. You can use Windows Defender (if you are on windows), but it may not be as reliable as antiviruses like McAfee [https://www.mcafee.com/]. Malwarebytes is another solid antivirus that comes at an affordable price ([https://www.malwarebytes.com/]). It may also be a good idea to have your local network hardened as well. Installing a firewall on your local network and having an Intrusion Detection System on your network can be very important in detecting if the malware got out of the virtual environment. Although you can easily break the bank with fancy Next Generation firewalls and military grade IDS systems, you don’t have to. For home use, a firewall like the pfSense (https://www.pfsense.org/) open-source firewall is a free firewall and IDSs like Snort (https://www.snort.org/) or Suricata (https://suricata-ids.org/) are also free and very effective. These open source, free firewall and IDS software’s can be installed and run on old desktops or even in Virtual machines in your network for very cheap. 

<h2>Moving on. What virtualization software do I need?</h2>
The two most common virtualization software platforms out on the market today are VMWare and VirtualBox (VBox). Both have their pros and cons. You cannot go wrong with either one. VMWare has many different virtualization products at different price points. The free VMWare workstation virtualization software that we are looking for is called Workstation Player (https://www.vmware.com/products/workstation-player.html) . The paid premium version of this is called Workstation Pro. VBox is an open source and completely free virtualization software that is supported on Windows, OS X, and various Linux distributions like Solaris, Ubuntu, and Debian (https://www.virtualbox.org/wiki/Downloads). 

![VMWare](/images/vmwareicon.png "VMWare")
![VBox](/images/virtualboxhero.jpg "VBox")

I have my virtual desktop. What Operating Systems should I deploy?
Some of the most common OS’s for Malware research and testing would include Windows 7, Windows 10, Windows server 2016 Ubuntu 15.10, Ubuntu 20.10, and more. Downloads:
  - Windows 7
      * https://www.microsoft.com/en-us/software-download/windows7
      * Note: You will need a product key
      Or
      * From here: https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/ 
  - Windows 10
      * https://www.microsoft.com/en-us/software-download/windows10 
      * Note: Guide to grab .iso file here (https://www.howtogeek.com/186775/how-to-download-windows-7-8-and-8.1-installation-media-legally/) 
  - Windows Server 2016
      * https://www.microsoft.com/en-us/evalcenter/evaluate-windows-server-2016 
  - Ubuntu 15.10
      * http://old-releases.ubuntu.com/releases/15.10/ 
  - Ubuntu 20.10
      * https://ubuntu.com/download/desktop

I recommend sticking to very common operating systems that regular users would be using at first and then start exploring other environments like Kali, Fedora, or other flavors of Linux and MacOS. This is because most malware is designed to run on and attack popular operating systems in order to increase infection rate and spread their malware. Much of the successful malware takes advantages of known vulnerabilities that have not been patched yet. The FBI actually released an article called “Top 10 Routinely Exploited Vulnerabilities” which included CVEs from 2012, 2017, 2018, and 2019 (https://us-cert.cisa.gov/ncas/alerts/aa20-133a). So, patch your systems.

<h2>Virtualization Software Setup</h2>
Once you have your Virtualization Software and the Operating Systems you want picked out, it is time to install and setup your environment. Each Operating System has different hardware allocation requirements. For example Windows 10 and Windows 7 recommend 2 GB of RAM for 64-bit architecture and 1 GB of RAM for 32-bit architecture (https://support.microsoft.com/en-us/windows/windows-10-system-requirements-6d4e9a79-66bf-7950-467c-795cf0386715), but Ubuntu 20.10 requires 4 GB of RAM (https://help.ubuntu.com/community/Installation/SystemRequirements). Researching each OS’s minimum system requirements is always good, but I recommend allocating more resources if you want them to run faster. A good rule of thumb is to allocate an additional 2 GB of RAM on top of the recommended minimum. 
In VBox you should be fine setting your network adapter to either NAT or Bridged. In VMWare you should set it to Host-Only. Remember that you should only have internet access turned on while downloading the malware and your various tools. Turn your network access off once you start analyzing and running the malware so it does not spread to your local network.

<h2>Setting Up Your Windows Testing Space</h2>
Booting into windows is probably familiar to you. Try to setup windows a normally as possible because we are trying to emulate a real-life machine for our malware to run on. Keep it simple and don’t over complicate it. I advise running a Windows update and then turning off Automatic Updates. It is a good idea to keep the operating system up to date but keeping the automatic updates off makes it less complicated when you want to know what version of Windows you are running. Some software to install include:
  - Microsoft Office
  -	Browsers like Chrome, Firefox, etc.
  -	Adobe Acrobat

Should I have antivirus and a firewall install? The answer to this is yes. I would have an antivirus like McAfee or even Windows Defender installed and enabled. You will most likely have to disable these when you go to download malware, but while running malware it may be interesting to see what that malware does to these systems. If the antivirus keeps blocking and deleting the malware, then you should of course disable and even uninstall that antivirus. 
Once you have your “normal” windows machine running it is a good time to take a Snapshot of the current setup. Snapshots are basically a save file of your current setup which allows you to instantly roll back to. A good rule of thumb is to create a new snapshot every time you make a major change to your VM or right before you plan on running some malware. After you’re done running the malware and you want to restart, just restore your system to the clean state.

<h4>Tools to have in your environment</h4>
  - From Sysinternals:
      * Process Explorer – shows which programs open up certain files or directories (https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) 
      * Process Monitor – “shows real-time file system, Registry and process/thread activity” (https://docs.microsoft.com/en-us/sysinternals/downloads/procmon) 
      * TCP View – “show you detailed listings of all TCP and UDP endpoints on your system” (https://docs.microsoft.com/en-us/sysinternals/downloads/tcpview)  
  -	Wireshark – allows you to monitor network pings that the malware tries to beacon to
  -	PeStudio – malware tool used to spot artifacts in executable files (https://www.winitor.com/) 
  -	RegShot – malware tool used to perform before and after snapshots of Windows Registry (https://sourceforge.net/projects/regshot/) 
  -	HxD – for a free hex editor for windows (https://mh-nexus.de/en/hxd/) 
  -	WinRAR – archive manager (https://www.rarlab.com/)

These are some tools to know and have in your toolbox, but you should not be limited to them. A version of VisualStudio Code may also be nice to have installed. 
Setting up and running the Nessus scanner on the virtualized host helps give you a good idea what vulnerabilities there are. 

<h2>Setting Up Linux Environment</h2>
When setting up your Linux environment a lot of the same ideology is used. We still want to be updated with automatic updates off. We still want an environment similar to one a normal user would have with common tools downloaded, including browsers, text editors, etc. Users can even install MS Office on their Linux machine (https://www.howtogeek.com/171565/how-to-install-microsoft-office-on-linux/). Linux has many tools already installed like the “top” command for process management. 

<h4>Tools to Install/use</h4>
  -	Wireshark of course
  -	Gnome System Monitor
  -	ProcMon For Linux – Basically Windows Process Monitor but for Linux (https://github.com/microsoft/ProcMon-for-Linux) 
  -	 Xxd Hex Editor or Hexedit 
      o	These may already be preinstalled on your Linux distribution.

If you have some Windows tools that have no Linux counterparts, you could always try to use Wine to run Windows applications on Linux (https://www.winehq.org/).

<h2>Where Can I Get Malware from to Practice?</h2>
TheZoo (https://github.com/ytisf/theZoo) is a GitHub repository of live malware that you can practice with. REMEMBER to always turn off your internet connection before running malware and that your host cannot communicate with any devices on your local network. I suggest even turning off the internet on the computer you are running the Virtualization software on.

<h4>Different things to do with this environment:</h4>
  -	Create a whole virtualized local network that allows you to simulate a real life local network
  -	Create a behavior list based on new releases of Malware
  -	Use this environment to install sketchy softwares that you don’t trust before installing on your real machine

<h4>Some books to read:</h4>
  -	Practical Malware Analysis: The Hands-On Guide to Dissecting (https://www.amazon.com/Practical-Malware-Analysis-Hands-Dissecting/dp/1593272901)
  -	Learning Malware Analysis (https://www.amazon.com/Learning-Malware-Analysis-techniques-investigate/dp/1788392507/) 
  -	Practical Binary Analysis (https://www.amazon.com/Practical-Binary-Analysis-Instrumentation-Disassembly/dp/1593279124/ )



